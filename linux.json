{
    "provisioners": [
        {
            "type": "file",
            "source": "./files/",
            "destination": "/tmp/"
        },
        {
            "type": "shell",
            "execute_command": "chmod +x {{.Path}}; {{.Vars}} sudo -E -S bash -x '{{.Path}}' '{{user `script`}}'",
            "scripts": [
                "./scripts/base/{{user `script`}}.sh",
                "./scripts/linux/mount.sh",
                "./scripts/linux/dns.sh",
                "./scripts/linux/packages.sh",
                "./scripts/linux/ssh.sh",
                "./scripts/linux/cloud-init.sh",
                "./scripts/linux/selinux.sh",
                "./scripts/linux/cleanup.sh"
            ]
        },
        {
            "type": "file",
            "source": "/tmp/packages",
            "destination": "/usr/local/packer/logs/packages/{{user `region`}}-{{user `ami_name`}}",
            "direction": "download"
        }
    ],
    "builders": [
        {
            "type": "osc-bsusurrogate",
            "access_key": "{{user `ak`}}",
            "secret_key": "{{user `sk`}}",
            "region": "{{user `region`}}",
            "ssh_username": "centos",
            "vm_type": "tinav4.c2r4p1",
            "source_omi": "{{user `omi`}}",
            "skip_region_validation": true,
	        "ssh_interface": "public_ip",
            "omi_virtualization_type": "hvm",
            "omi_name": "{{user `ami_name`}}",
            "subregion_name": "{{user `region`}}a",
            "launch_block_device_mappings": [
                {
            	    "volume_type": "io1",
                    "iops": 3000,
            	    "device_name": "/dev/xvdf",
            	    "delete_on_vm_deletion": true,
            	    "volume_size": "{{user `volume_size`}}"
                }
            ],
            "omi_root_device": {
                "delete_on_vm_deletion": true,
                "source_device_name": "/dev/xvdf",
                "device_name": "/dev/sda1",
                "volume_size": "{{user `volume_size`}}",
                "volume_type": "standard"
            }
        }
    ],
    "variables": {
        "ami_name": "{{env `AMI_NAME`}}",
        "region": "{{env `REGION`}}",
        "ak": "{{env `OSC_ACCESS_KEY`}}",
        "sk": "{{env `OSC_SECRET_KEY`}}",
        "script": "{{env `SCRIPT_BASE`}}",
        "omi": "{{env `SOURCE_OMI`}}",
        "volume_size": "{{env `VOL_SIZE`}}"
    }
}
